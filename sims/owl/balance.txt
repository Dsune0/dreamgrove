# Executed before combat begins. Accepts non-harmful actions only.
actions.precombat=flask
actions.precombat+=/food
actions.precombat+=/augmentation
actions.precombat+=/snapshot_stats
actions.precombat+=/moonkin_form
actions.precombat+=/wrath
actions.precombat+=/wrath
actions.precombat+=/starfire,if=!talent.stellar_flare
actions.precombat+=/stellar_flare

# Executed every time the actor is available.
actions=variable,name=is_aoe,value=spell_targets.starfall>(1+(!talent.aetherial_kindling&!talent.starweaver))&talent.starfall
actions+=/variable,name=passive_asp,value=6%spell_haste+talent.natures_balance+talent.orbit_breaker*dot.moonfire.ticking*(buff.orbit_breaker.stack>(27-2*buff.solstice.up))*40
actions+=/use_items,if=eclipse.in_both|fight_remains<20
actions+=/potion,if=eclipse.in_both|fight_remains<30
actions+=/run_action_list,name=aoe,if=variable.is_aoe
actions+=/run_action_list,name=st

actions.aoe=moonfire,target_if=refreshable&(target.time_to_die-remains)>6&astral_power.deficit>variable.passive_asp+energize_amount,if=fight_style.dungeonroute
actions.aoe+=/sunfire,target_if=refreshable&(target.time_to_die-remains)>6-(spell_targets%2)&astral_power.deficit>variable.passive_asp+energize_amount
actions.aoe+=/moonfire,target_if=refreshable&(target.time_to_die-remains)>6&astral_power.deficit>variable.passive_asp+energize_amount,if=!fight_style.dungeonroute
actions.aoe+=/stellar_flare,target_if=refreshable
actions.aoe+=/force_of_nature
actions.aoe+=/fury_of_elune
actions.aoe+=/incarnation
actions.aoe+=/celestial_alignment
actions.aoe+=/warrior_of_elune,if=!talent.lunar_calling&buff.eclipse_solar.remains<7|talent.lunar_calling
actions.aoe+=/starfire,if=(!talent.lunar_calling&spell_targets.starfire=1)&(buff.eclipse_solar.up&buff.eclipse_solar.remains<action.starfire.cast_time|eclipse.in_none)
actions.aoe+=/wrath,if=(talent.lunar_calling|spell_targets.starfire>1)&(buff.eclipse_lunar.up&(buff.eclipse_lunar.remains<action.wrath.cast_time)|eclipse.in_none)
actions.aoe+=/starfall,if=buff.starweavers_warp.up
actions.aoe+=/starsurge,if=spell_targets.starfall<2
actions.aoe+=/starfall,if=spell_targets.starfall>1
actions.aoe+=/convoke_the_spirits
actions.aoe+=/new_moon
actions.aoe+=/half_moon
actions.aoe+=/full_moon
actions.aoe+=/warrior_of_elune
actions.aoe+=/wild_mushroom
actions.aoe+=/starfire,if=talent.lunar_calling|buff.eclipse_lunar.up&spell_targets.starfire>1
actions.aoe+=/wrath


actions.st=sunfire,target_if=refreshable&remains<2&(target.time_to_die-remains)>6
actions.st+=/moonfire,target_if=refreshable&remains<2&(target.time_to_die-remains)>6
actions.st+=/stellar_flare,target_if=refreshable
actions.st+=/force_of_nature,if=eclipse.in_solar&buff.eclipse_solar.remains>4&cooldown.celestial_alignment.remains>15|cooldown.celestial_alignment.ready|fight_remains<10
actions.st+=/fury_of_elune
actions.st+=/incarnation
actions.st+=/celestial_alignment
actions.st+=/warrior_of_elune,if=!talent.lunar_calling&buff.eclipse_solar.remains<7|talent.lunar_calling
actions.st+=/starfire,if=(!talent.lunar_calling&spell_targets.starfire=1)&(buff.eclipse_solar.up&buff.eclipse_solar.remains<action.starfire.cast_time|eclipse.in_none)
actions.st+=/wrath,if=(talent.lunar_calling|spell_targets.starfire>1)&(buff.eclipse_lunar.up&(buff.eclipse_lunar.remains<action.wrath.cast_time)|eclipse.in_none)
actions.st+=/starfall,if=buff.starweavers_warp.up
actions.st+=/starsurge,if=buff.starlord.up&buff.starlord.stack<3|cooldown.convoke_the_spirits.ready
actions.st+=/convoke_the_spirits,if=eclipse.in_both|cooldown.celestial_alignment.remains>55
actions.st+=/starsurge,if=astral_power.deficit<variable.passive_asp+action.wrath.energize_amount+(action.starfire.energize_amount+variable.passive_asp)*(buff.eclipse_solar.remains<(gcd.max*3))|fight_remains<5
actions.st+=/new_moon
actions.st+=/half_moon
actions.st+=/full_moon
actions.st+=/warrior_of_elune
actions.st+=/wild_mushroom
actions.st+=/starfire,if=talent.lunar_calling|buff.eclipse_lunar.up&spell_targets.starfire>1
actions.st+=/wrath
